<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Oman Region Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial;
      margin: 0;
      padding: 20px;
      background: #f4f4f4;
    }
    h2 {
      text-align: center;
    }
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 10px #ccc;
    }
    th, td {
      padding: 15px;
      text-align: center;
      border: 1px solid #ddd;
      word-wrap: break-word;
    }
    th {
      background: #333;
      color: white;
    }
    .circle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
    }
    .green { background: #10b981; }
    .red { background: #ef4444; }
    .orange { background: #f59e0b; }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 450px;
      border-radius: 10px;
      max-height: 80%;
      overflow-y: auto;
    }
    .school-item {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
    }
    select {
      padding: 4px;
    }
    .close-btn {
      float: right;
      cursor: pointer;
      color: red;
    }
  </style>
</head>
<body>

<h2>Oman Region Project Dashboard</h2>

<table>
  <thead>
    <tr>
      <th>Region</th>
      <th>Socket</th>
      <th>Paints</th>
      <th>Software Installation</th>
      <th>Screen Installation</th>
    </tr>
  </thead>
  <tbody id="dashboardBody">
    <!-- JS will render this -->
  </tbody>
</table>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">âœ–</span>
    <h3 id="modalTitle"></h3>
    <div id="schoolList"></div>
  </div>
</div>

<script>
  // Replace this config with yours
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const tasks = ["Socket", "Paints", "Software Installation", "Screen Installation"];
  const regions = [
    "Muscat", "Salalah", "Sohar", "Sur", "Nizwa", "Ibri", "Barka", "Buraimi",
    "Duqm", "Rustaq", "Bahla", "Ibra", "Khasab", "Samail"
  ];

  const dashboardBody = document.getElementById("dashboardBody");

  function getColor(statuses) {
    if (statuses.length === 0) return 'red';
    if (statuses.every(s => s === 'green')) return 'green';
    if (statuses.some(s => s === 'orange')) return 'orange';
    return 'red';
  }

  async function loadDashboard() {
    dashboardBody.innerHTML = "";
    for (const region of regions) {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${region}</td>`;
      for (const task of tasks) {
        const cell = document.createElement('td');
        cell.dataset.region = region;
        cell.dataset.task = task;

        const snap = await db.collection('statuses')
          .doc(region).collection(task).get();

        const statuses = snap.docs.map(doc => doc.data().status);
        const finalStatus = getColor(statuses);
        cell.innerHTML = `<span class="circle ${finalStatus}"></span>`;
        cell.onclick = () => openModal(region, task);
        row.appendChild(cell);
      }
      dashboardBody.appendChild(row);
    }
  }

  async function openModal(region, task) {
    document.getElementById("modal").style.display = "flex";
    document.getElementById("modalTitle").textContent = `${region} - ${task}`;

    const container = document.getElementById("schoolList");
    container.innerHTML = "";

    const snap = await db.collection("statuses")
      .doc(region).collection(task).get();

    snap.forEach(doc => {
      const school = doc.id;
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "school-item";
      div.innerHTML = `
        <span>${school}</span>
        <select onchange="updateStatus('${region}', '${task}', '${school}', this.value)">
          <option value="green" ${data.status === 'green' ? 'selected' : ''}>Green</option>
          <option value="orange" ${data.status === 'orange' ? 'selected' : ''}>Orange</option>
          <option value="red" ${data.status === 'red' ? 'selected' : ''}>Red</option>
        </select>
      `;
      container.appendChild(div);
    });
  }

  async function updateStatus(region, task, school, newStatus) {
    await db.collection("statuses")
      .doc(region)
      .collection(task)
      .doc(school)
      .set({ status: newStatus });

    loadDashboard(); // refresh the main grid
  }

  function closeModal() {
    document.getElementById("modal").style.display = "none";
  }

  loadDashboard();
</script>

</body>
</html>
